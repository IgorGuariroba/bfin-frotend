name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  deploy:
    name: ðŸš€ Deploy to Render
    runs-on: ubuntu-latest
    # SÃ³ faz deploy se o CI passou
    needs: []

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ” Setup NPM Authentication
        run: |
          echo "@igorguariroba:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" >> .npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”Ž TypeScript Check
        run: npm run type-check

      - name: ðŸ—ï¸ Build Application
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      - name: ðŸš€ Trigger Render Deploy
        if: success()
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
        continue-on-error: true

      - name: âœ… Deploy Summary
        run: |
          echo "# ðŸš€ Deploy Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
