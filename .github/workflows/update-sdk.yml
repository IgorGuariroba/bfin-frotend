name: ðŸ”„ Update BFIN SDK

on:
  schedule:
    # Executa toda segunda-feira Ã s 09:00 UTC
    - cron: '0 9 * * MON'
  workflow_dispatch: # Permite execuÃ§Ã£o manual
    inputs:
      force_update:
        description: 'ForÃ§ar atualizaÃ§Ã£o mesmo se jÃ¡ estiver na Ãºltima versÃ£o'
        required: false
        default: 'false'

jobs:
  update-sdk:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ”½ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ”‘ Configurar NPM Token
      run: |
        echo "NPM_TOKEN=${{ secrets.NPM_TOKEN }}" > .env

    - name: ðŸ“‹ Configurar .npmrc
      run: npm run setup:npmrc

    - name: ðŸ“¥ Instalar dependÃªncias
      run: npm ci

    - name: ðŸ” Verificar e atualizar SDK
      id: update
      run: |
        # Verificar versÃ£o atual
        CURRENT=$(npm view @igorguariroba/bfin-sdk version --prefix .)
        LATEST=$(npm view @igorguariroba/bfin-sdk version)

        echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
        echo "latest_version=$LATEST" >> $GITHUB_OUTPUT

        if [ "$CURRENT" != "$LATEST" ] || [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          echo "needs_update=true" >> $GITHUB_OUTPUT
          npm run update:sdk
        else
          echo "needs_update=false" >> $GITHUB_OUTPUT
          echo "âœ… SDK jÃ¡ estÃ¡ na versÃ£o mais recente: $LATEST"
        fi

    - name: ðŸš€ Criar Pull Request
      if: steps.update.outputs.needs_update == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore(sdk): atualizar @igorguariroba/bfin-sdk para v${{ steps.update.outputs.latest_version }}

          - VersÃ£o anterior: ${{ steps.update.outputs.current_version }}
          - Nova versÃ£o: ${{ steps.update.outputs.latest_version }}
          - AtualizaÃ§Ã£o automÃ¡tica via GitHub Actions
        title: ðŸ”„ Atualizar BFIN SDK para v${{ steps.update.outputs.latest_version }}
        body: |
          ## ðŸ“¦ AtualizaÃ§Ã£o AutomÃ¡tica do SDK

          Este PR atualiza o `@igorguariroba/bfin-sdk` automaticamente.

          ### ðŸ“‹ Resumo das alteraÃ§Ãµes:
          - **VersÃ£o anterior:** `${{ steps.update.outputs.current_version }}`
          - **Nova versÃ£o:** `${{ steps.update.outputs.latest_version }}`

          ### âœ… ValidaÃ§Ãµes executadas:
          - [x] TypeScript check passou
          - [x] ESLint passou
          - [x] InstalaÃ§Ã£o bem-sucedida

          ### ðŸ” PrÃ³ximos passos:
          1. Revisar as alteraÃ§Ãµes
          2. Executar testes: `npm test -- --run`
          3. Testar a aplicaÃ§Ã£o localmente
          4. Fazer merge se tudo estiver funcionando

          ---

          > ðŸ¤– Este PR foi criado automaticamente pelo workflow `update-sdk.yml`
        branch: chore/update-sdk-v${{ steps.update.outputs.latest_version }}
        labels: |
          dependencies
          bfin-sdk
          automated
        reviewers: IgorGuariroba
        assignees: IgorGuariroba